<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ë°©íƒˆì¶œ: í•™êµ êµì¹™ ì•Œì•„ë³´ê¸° (ìˆœì°¨ì§„í–‰)</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #333;
        }

        /* íƒ€ì´ë¨¸ ìŠ¤íƒ€ì¼ */
        #timer {
            display: none; position: fixed;
            top: 15px; left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white; padding: 10px 25px;
            border-radius: 20px; font-size: 1.5rem;
            font-weight: bold; z-index: 1500;
            border: 2px solid white;
        }

        /* ì‹œì‘ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #start-screen {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(to bottom right, #4a90e2, #2a64a3);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; color: white;
        }
        .start-box {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 40px; border-radius: 20px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .start-box h1 { margin-top: 0; font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.4); }
        .start-box p { font-size: 1.1rem; margin-bottom: 30px; }
        .start-box input {
            display: block; width: 250px;
            padding: 12px; margin: 10px auto;
            border-radius: 8px; border: 1px solid #ccc;
            font-size: 1rem;
        }
        #start-game-btn {
            background-color: #f5a623; color: white;
            padding: 15px 40px; border: none;
            border-radius: 10px; font-size: 1.2rem;
            font-weight: bold; cursor: pointer; margin-top: 20px;
            transition: background-color 0.3s, transform 0.2s;
        }
        #start-game-btn:hover { background-color: #d88e14; transform: scale(1.05); }

        /* ìŠ¤í…Œì´ì§€ ì»¨í…Œì´ë„ˆ */
        .stage-container {
            display: none; position: relative;
            width: 100%; max-width: 1280px;
            margin: auto;
        }
        .stage-container img {
            width: 100%; height: auto; display: block;
        }

        /* í´ë¦­ ê°€ëŠ¥í•œ ì˜¤ë¸Œì íŠ¸ */
        .interactive-object {
            position: absolute; cursor: pointer;
            background-color: rgba(255, 255, 0, 0.0);
            border: 2px solid transparent;
            border-radius: 10px;
            transition: background-color 0.3s, border 0.3s;
        }
        .interactive-object:hover {
            background-color: rgba(255, 255, 0, 0.4);
            border: 2px solid yellow;
        }
        /* ì ê¸´ ì˜¤ë¸Œì íŠ¸ ìŠ¤íƒ€ì¼ */
        .interactive-object.locked {
            cursor: not-allowed;
            pointer-events: none;
        }
        .interactive-object.locked:hover {
             background-color: transparent;
             border-color: transparent;
        }
        /* í•´ê²°ëœ ì˜¤ë¸Œì íŠ¸ ìŠ¤íƒ€ì¼ */
        .interactive-object.solved {
            cursor: default; pointer-events: none;
        }
        .interactive-object.solved:hover {
             background-color: transparent;
             border-color: transparent;
        }


        #s1-obj-skeleton { top: 25%; left: 10%; width: 12%; height: 50%; }
        #s1-obj-tools { top: 65%; left: 80%; width: 20%; height: 20%; }
        #s1-obj-box { top: 70%; left: 40%; width: 15%; height: 30%; }
        #s1-obj-door { top: 0%; left: 50%; width: 12%; height: 65%; }
        #s1-obj-board { top: 0%; left: 0%; width: 0.1%; height: 0.1%; }

        #s2-obj-statue { top: 35%; left: 45%; width: 10%; height: 50%; }
        #s2-obj-piano { top: 60%; left: 5%; width: 35%; height: 35%; }
        #s2-obj-desk { top: 50%; left: 88%; width: 35%; height: 30%; }
        #s2-obj-door { top: 35%; left: 80%; width: 15%; height: 60%; }
        #s2-obj-board { top: 0%; left: 0%; width: 30%; height: 30%; }

        #s3-obj-soccer-ball { top: 80%; left: 45%; width: 10%; height: 15%; }
        #s3-obj-goalpost { top: 5%; left: 65%; width: 25%; height: 40%; }
        #s3-obj-swing { top: 27%; left: 30%; width: 15%; height: 35%; }
        #s3-obj-exit-door { top: 10%; left: 0%; width: 20%; height: 35%; }
        #s3-obj-signboard { top: 0%; left: 0.1%; width: 0.1%; height: 0.1%; }

        .modal-wrapper {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 25px;
            border-radius: 15px; text-align: center;
            width: 90%; max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h2 { margin-top: 0; }
        .modal-content p { margin-bottom: 20px; line-height: 1.6; }
        .modal-content input {
            width: 80%; padding: 10px; margin-bottom: 10px;
            text-align: center; font-size: 1.2rem;
            border: 1px solid #ccc; border-radius: 5px;
        }
        .modal-content button {
            padding: 12px 24px; border: none;
            background-color: #007bff; color: white;
            border-radius: 8px; cursor: pointer;
            font-size: 1rem; font-weight: bold;
        }
        .modal-content button:hover { background-color: #0056b3; }
        .modal-content button:disabled, .modal-content input:disabled {
            background-color: #ccc; cursor: not-allowed;
        }
        .modal-content button:hover:disabled { background-color: #ccc; }
        .close-btn { background-color: #6c757d !important; }
        #next-stage-btn { background-color: #28a745 !important; }

        .feedback {
            margin-top: 15px; font-weight: bold; min-height: 20px;
        }

        .memory-board {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 10px; margin-bottom: 20px;
        }
        .card {
            aspect-ratio: 1 / 1; position: relative; cursor: pointer;
            transform-style: preserve-3d; transition: transform 0.6s;
        }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { cursor: default; }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; display: flex;
            justify-content: center; align-items: center;
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            border-radius: 8px; overflow: hidden;
        }
        #s1-memory-board .card-front { background-color: #4a90e2; }
        #s2-memory-board .card-front { background-color: #5d4037; }
        #s3-memory-board .card-front { background-color: #4caf50; }
        .card-back { background-color: #f0f0f0; transform: rotateY(180deg); }
    </style>
</head>
<body>
    
    <div id="timer">00:00</div>
    <div id="start-screen">
        <div class="start-box">
            <h1>ë°©íƒˆì¶œ: í•™êµ êµì¹™ ì•Œì•„ë³´ê¸°</h1>
            <p>ì°¸ê°€ì ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
            <input type="number" id="player-grade" placeholder="í•™ë…„">
            <input type="number" id="player-class" placeholder="ë°˜">
            <input type="text" id="player-name" placeholder="ì´ë¦„">
            <button id="start-game-btn">ê²Œì„ ì‹œì‘</button>
        </div>
    </div>

    <!-- STAGE 1: ê³¼í•™ì‹¤ -->
    <div id="stage-1" class="stage-container">
        <img src="https://i.ibb.co/NdCcsNzd/1-final.jpg" alt="ê³¼í•™ì‹¤ ë°°ê²½">
        <div class="interactive-object" id="s1-obj-board"></div>
        <div class="interactive-object" id="s1-obj-skeleton"></div>
        <div class="interactive-object locked" id="s1-obj-tools"></div>
        <div class="interactive-object" id="s1-obj-box"></div>
        <div class="interactive-object" id="s1-obj-door"></div>
    </div>
    <!-- STAGE 2: ìŒì•…ì‹¤ -->
    <div id="stage-2" class="stage-container">
        <img src="https://i.ibb.co/nMsGycG4/Whisk-c32be9cb17.jpg" alt="ìŒì•…ì‹¤ ë°°ê²½">
        <div class="interactive-object" id="s2-obj-board"></div>
        <div class="interactive-object" id="s2-obj-statue"></div>
        <div class="interactive-object locked" id="s2-obj-desk"></div>
        <div class="interactive-object" id="s2-obj-piano"></div>
        <div class="interactive-object" id="s2-obj-door"></div>
    </div>
    <!-- STAGE 3: ìš´ë™ì¥ -->
    <div id="stage-3" class="stage-container">
        <img src="https://i.ibb.co/1GdxBwz7/Whisk-98370763db.jpg" alt="ìš´ë™ì¥ ë°°ê²½">
        <div class="interactive-object" id="s3-obj-signboard"></div>
        <div class="interactive-object" id="s3-obj-soccer-ball"></div>
        <div class="interactive-object locked" id="s3-obj-goalpost"></div>
        <div class="interactive-object" id="s3-obj-swing"></div>
        <div class="interactive-object" id="s3-obj-exit-door"></div>
    </div>

    <!-- ëª¨ë‹¬ ì˜ì—­ (HTML êµ¬ì¡°ëŠ” ì´ì „ê³¼ ë™ì¼) -->
    <div id="s1-modal-hint" class="modal-wrapper"><div class="modal-content"><h2>ê¸°ë³¸ ê·œì¹™</h2><p>ì¹ íŒì— ë¶„í•„ë¡œ ì“°ì—¬ìˆë‹¤.<br>"íƒˆì¶œ ë¹„ë°€ë²ˆí˜¸ëŠ” ì´ ê³¼í•™ì‹¤ì—ì„œ ì°¾ì„ ìˆ˜ ìˆëŠ” **ë‘ ê°œì˜ êµì¹™ ë²ˆí˜¸**ë¥¼ ì¡°í•©í•œ ë„¤ ìë¦¬ ìˆ«ìë‹¤."</p><button class="close-btn">ë‹«ê¸°</button></div></div>
    <div id="s1-modal-problem1" class="modal-wrapper"><div class="modal-content"><h2>ì²« ë²ˆì§¸ ë¬¸ì œ</h2><p>í•´ê³¨ ëª¨í˜• ëª©ì— ì‘ì€ ë©”ëª¨ê°€ ê±¸ë ¤ìˆë‹¤.<br><strong>"êµì¹™ ì œ 03ì¡°: ë³µë„ì—ì„œëŠ” í•­ìƒ ì¡°ìš©íˆ, ì²œì²œíˆ!"</strong><br>ì´ êµì¹™ì˜ ì¡°í•­ ë²ˆí˜¸ê°€ ë¹„ë°€ë²ˆí˜¸ì˜ ì²« ë¶€ë¶„ì¸ ê²ƒ ê°™ë‹¤.</p><input type="text" id="s1-answer1" placeholder="ë‘ ìë¦¬ ìˆ«ì" maxlength="2"><button id="s1-submit1">í™•ì¸</button><p id="s1-feedback1" class="feedback"></p></div></div>
    <div id="s1-modal-problem2" class="modal-wrapper"><div class="modal-content"><h2>ë‘ ë²ˆì§¸ ë¬¸ì œ</h2><p>ìœ„í—˜í•´ ë³´ì´ëŠ” ì‹¤í—˜ë„êµ¬ ì•ì— ê²½ê³ ë¬¸ì´ ë¶™ì–´ìˆë‹¤.<br><strong>"êµì¹™ ì œ 30ì¡°: ì„ ìƒë‹˜ì˜ í—ˆë½ ì—†ì´ëŠ” ì ˆëŒ€ ì‹¤í—˜ ë„êµ¬ë¥¼ ë§Œì§€ì§€ ë§ ê²ƒ!"</strong><br>ì´ ê²½ê³ ë¬¸ì˜ êµì¹™ ë²ˆí˜¸ê°€ ë¹„ë°€ë²ˆí˜¸ì˜ ë’·ë¶€ë¶„ì´ ì•„ë‹ê¹Œ?</p><input type="text" id="s1-answer2" placeholder="ë‘ ìë¦¬ ìˆ«ì" maxlength="2"><button id="s1-submit2">í™•ì¸</button><p id="s1-feedback2" class="feedback"></p></div></div>
    <div id="s1-modal-minigame" class="modal-wrapper"><div class="modal-content"><h2>ê³¼í•™ ë„êµ¬ ì¹´ë“œ ë§ì¶”ê¸°</h2><div id="s1-memory-board" class="memory-board"></div><p id="s1-minigame-feedback" class="feedback"></p><button class="close-btn">ë‚˜ê°€ê¸°</button></div></div>
    <div id="s1-modal-final" class="modal-wrapper"><div class="modal-content"><h2>[ê³¼í•™ì‹¤] íƒˆì¶œ ë¹„ë°€ë²ˆí˜¸</h2><p>ì°¾ì•„ë‚¸ ë„¤ ìë¦¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p><input type="password" id="s1-final-password" maxlength="4" placeholder="****"><button id="s1-submit-final">íƒˆì¶œ!</button><p id="s1-final-feedback" class="feedback"></p></div></div>
    <div id="s2-modal-hint" class="modal-wrapper"><div class="modal-content"><h2>ê¸°ë³¸ ê·œì¹™</h2><p>ì¹ íŒì— ì˜¤ëŠ˜ì˜ ê¸‰í›ˆì´ ì í˜€ìˆë‹¤.<br>"íƒˆì¶œì˜ ì—´ì‡ ëŠ” êµì¹™ ì•ˆì— ìˆë‹¤. **ë‘ ê°œì˜ êµì¹™ ë²ˆí˜¸**ë¥¼ ì°¾ì•„ë¼!"</p><button class="close-btn">ë‹«ê¸°</button></div></div>
    <div id="s2-modal-problem1" class="modal-wrapper"><div class="modal-content"><h2>ì²« ë²ˆì§¸ ë¬¸ì œ</h2><p>ë² í† ë²¤ í‰ìƒ ì•„ë˜ì— ì‘ì€ ê¸€ì”¨ë¡œ êµì¹™ì´ ìƒˆê²¨ì ¸ ìˆë‹¤.<br><strong>"êµì¹™ ì œ 1ì¡°: ë‹¤ë¥¸ í•™ìƒì„ ì¡´ì¤‘í•˜ê³  ë°°ë ¤í•œë‹¤."</strong><br>ì´ êµì¹™ì˜ ì¡°í•­ ë²ˆí˜¸ê°€ ë¹„ë°€ë²ˆí˜¸ì˜ ì²« ë¶€ë¶„ì¼ê¹Œ? ë‘ ìë¦¬ë¡œ ë§Œë“¤ì–´ì•¼ í•  ê²ƒ ê°™ë‹¤.</p><input type="text" id="s2-answer1" placeholder="ë‘ ìë¦¬ ìˆ«ì" maxlength="2"><button id="s2-submit1">í™•ì¸</button><p id="s2-feedback1" class="feedback"></p></div></div>
    <div id="s2-modal-problem2" class="modal-wrapper"><div class="modal-content"><h2>ë‘ ë²ˆì§¸ ë¬¸ì œ</h2><p>ì„ ìƒë‹˜ ì±…ìƒ ìœ„, ì˜¤ë˜ëœ ë©”íŠ¸ë¡œë†ˆì— êµì¹™ ìŠ¤í‹°ì»¤ê°€ ë¶™ì–´ìˆë‹¤.<br><strong>"êµì¹™ ì œ 18ì¡°: ìˆ˜ì—… ì‹œê°„ì„ ë°˜ë“œì‹œ ì§€í‚¨ë‹¤."</strong> <br>ì´ êµì¹™ì˜ ì¡°í•­ ë²ˆí˜¸ê°€ ë¹„ë°€ë²ˆí˜¸ì˜ ë§ˆì§€ë§‰ ë‘ ìë¦¬ê°€ í‹€ë¦¼ì—†ë‹¤.</p><input type="text" id="s2-answer2" placeholder="ë‘ ìë¦¬ ìˆ«ì" maxlength="2"><button id="s2-submit2">í™•ì¸</button><p id="s2-feedback2" class="feedback"></p></div></div>
    <div id="s2-modal-minigame" class="modal-wrapper"><div class="modal-content"><h2>ì•…ê¸° ì¹´ë“œ ë§ì¶”ê¸°</h2><div id="s2-memory-board" class="memory-board"></div><p id="s2-minigame-feedback" class="feedback"></p><button class="close-btn">ë‚˜ê°€ê¸°</button></div></div>
    <div id="s2-modal-final" class="modal-wrapper"><div class="modal-content"><h2>[ìŒì•…ì‹¤] íƒˆì¶œ ë¹„ë°€ë²ˆí˜¸</h2><p>ì°¾ì•„ë‚¸ ë„¤ ìë¦¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p><input type="password" id="s2-final-password" maxlength="4" placeholder="****"><button id="s2-submit-final">íƒˆì¶œ!</button><p id="s2-final-feedback" class="feedback"></p></div></div>
    <div id="s3-modal-hint" class="modal-wrapper"><div class="modal-content"><h2>ìš´ë™ì¥ ì´ìš© ìˆ˜ì¹™</h2><p>ì´ ìš´ë™ì¥ì—ì„œ ë‚˜ê°ˆ ìˆ˜ ìˆëŠ” ë¹„ë°€ë²ˆí˜¸ëŠ”, ì´ê³³ì—ì„œ ì°¾ì„ ìˆ˜ ìˆëŠ” **ë‘ ê°œì˜ êµì¹™ ë²ˆí˜¸**ë¡œ ì´ë£¨ì–´ì ¸ ìˆë‹¤.</p><button class="close-btn">ë‹«ê¸°</button></div></div>
    <div id="s3-modal-problem1" class="modal-wrapper"><div class="modal-content"><h2>ì²« ë²ˆì§¸ ë¬¸ì œ</h2><p>ì¶•êµ¬ê³µì— ì‘ì€ ê¸€ì”¨ê°€ ì“°ì—¬ ìˆë‹¤.<br><strong>"êµì¹™ ì œ 01ì¡°: ìš´ë™ì¥ì—ì„œëŠ” í•­ìƒ ì•ˆì „ì— ìœ ì˜í•œë‹¤."</strong><br>ì´ êµì¹™ì˜ ë²ˆí˜¸ê°€ ë¹„ë°€ë²ˆí˜¸ì˜ ì²« ë¶€ë¶„ì¼ê¹Œ? (ë‘ ìë¦¬ë¡œ ì…ë ¥)</p><input type="text" id="s3-answer1" placeholder="ë‘ ìë¦¬ ìˆ«ì" maxlength="2"><button id="s3-submit1">í™•ì¸</button><p id="s3-feedback1" class="feedback"></p></div></div>
    <div id="s3-modal-problem2" class="modal-wrapper"><div class="modal-content"><h2>ë‘ ë²ˆì§¸ ë¬¸ì œ</h2><p>ê³¨ëŒ€ì— ë‚¡ì€ ìŠ¤í‹°ì»¤ê°€ ë¶™ì–´ìˆë‹¤.<br><strong>"êµì¹™ ì œ 04ì¡°: ì‚¬ìš©í•œ ìš´ë™ê¸°êµ¬ëŠ” ì œìë¦¬ì— ë‘”ë‹¤."</strong> <br>ì´ êµì¹™ì˜ ë²ˆí˜¸ê°€ ë¹„ë°€ë²ˆí˜¸ì˜ ë’·ë¶€ë¶„ì¸ ê²ƒ ê°™ë‹¤. (ë‘ ìë¦¬ë¡œ ì…ë ¥)</p><input type="text" id="s3-answer2" placeholder="ë‘ ìë¦¬ ìˆ«ì" maxlength="2"><button id="s3-submit2">í™•ì¸</button><p id="s3-feedback2" class="feedback"></p></div></div>
    <div id="s3-modal-minigame" class="modal-wrapper"><div class="modal-content"><h2>ìš´ë™ê¸°êµ¬ ì¹´ë“œ ë§ì¶”ê¸°</h2><div id="s3-memory-board" class="memory-board"></div><p id="s3-minigame-feedback" class="feedback"></p><button class="close-btn">ë‚˜ê°€ê¸°</button></div></div>
    <div id="s3-modal-final" class="modal-wrapper"><div class="modal-content"><h2>[ìš´ë™ì¥] ìµœì¢… íƒˆì¶œ</h2><p>ì°¾ì•„ë‚¸ ë„¤ ìë¦¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p><input type="password" id="s3-final-password" maxlength="4" placeholder="****"><button id="s3-submit-final">íƒˆì¶œ!</button><p id="s3-final-feedback" class="feedback"></p></div></div>
    <div id="stage-clear-modal" class="modal-wrapper"><div class="modal-content"><h2 id="clear-title"></h2><p id="clear-message"></p><button id="next-stage-btn">ë‹¤ìŒ ì¥ì†Œë¡œ ì´ë™</button></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const startScreen = document.getElementById('start-screen');
            const startGameBtn = document.getElementById('start-game-btn');
            const timerElement = document.getElementById('timer');
            let timerInterval;
            let startTime;

            const showModal = (modalId) => { document.getElementById(modalId).style.display = 'flex'; };
            const hideModal = (modalId) => { document.getElementById(modalId).style.display = 'none'; };
            
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.modal-wrapper').style.display = 'none';
                });
            });

            startGameBtn.addEventListener('click', () => {
                startScreen.style.display = 'none';
                document.getElementById('stage-1').style.display = 'block';
                timerElement.style.display = 'block';
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
            });
            
            function updateTimer() {
                const elapsedTime = Date.now() - startTime;
                const totalSeconds = Math.floor(elapsedTime / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                timerElement.textContent = formattedTime;
            }

            let currentStage = 1;
            document.getElementById('next-stage-btn').addEventListener('click', () => {
                const nextStageNum = ++currentStage;
                document.querySelectorAll('.stage-container').forEach(s => s.style.display = 'none');
                document.getElementById(`stage-${nextStageNum}`).style.display = 'block';
                hideModal('stage-clear-modal');
            });

            // ==========================================================
            // --- ìŠ¤í…Œì´ì§€ë³„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • í•¨ìˆ˜ (ìˆ˜ì •ëœ ë²„ì „) ---
            // ==========================================================
            function setupStageEventListeners(stageNum, puzzles, finalPassword, nextStageMessage) {
                const problemStatus = {}; // ê° ìŠ¤í…Œì´ì§€ì˜ ë¬¸ì œ í’€ì´ ìƒíƒœ

                puzzles.forEach(p => {
                    const objEl = document.getElementById(`s${stageNum}-obj-${p.obj}`);
                    if (!objEl) return;
                    
                    if (p.isProblem) {
                        problemStatus[p.probNum] = false;
                    }

                    objEl.addEventListener('click', () => {
                        // ë¬¸ì œê°€ ì ê²¨ìˆìœ¼ë©´ í´ë¦­ ë¶ˆê°€
                        if (objEl.classList.contains('locked')) {
                            alert('ì§€ê¸ˆì€ ì¡°ì‚¬í•  ìˆ˜ ì—†ë‹¤. ë‹¤ë¥¸ ë‹¨ì„œë¥¼ ë¨¼ì € ì°¾ì•„ë³´ì.');
                            return;
                        }
                        // ì´ë¯¸ í•´ê²°í•œ ë¬¸ì œëŠ” í´ë¦­ ë¶ˆê°€
                        if (objEl.classList.contains('solved')) return;

                        if (p.isGame) {
                            startMemoryGame(stageNum, p.gameData.icons, p.gameData.frontIcon, p.gameData.successMsg);
                        }
                        showModal(`s${stageNum}-modal-${p.modal}`);
                    });

                    if (p.isProblem) {
                        const submitBtn = document.getElementById(`s${stageNum}-submit${p.probNum}`);
                        const answerEl = document.getElementById(`s${stageNum}-answer${p.probNum}`);
                        const feedbackEl = document.getElementById(`s${stageNum}-feedback${p.probNum}`);

                        submitBtn.addEventListener('click', () => {
                            if (answerEl.value === p.answer) {
                                feedbackEl.textContent = `ì •ë‹µ! íŒíŠ¸ '${p.answer}'ì„(ë¥¼) ì°¾ì•˜ë‹¤.`;
                                feedbackEl.style.color = 'green';
                                
                                answerEl.disabled = true;
                                submitBtn.disabled = true;
                                problemStatus[p.probNum] = true;
                                objEl.classList.add('solved');

                                // ë‹¤ìŒ ë¬¸ì œ ì˜¤ë¸Œì íŠ¸ì˜ 'locked' í´ë˜ìŠ¤ ì œê±°
                                const nextProbNum = p.probNum + 1;
                                const nextObj = puzzles.find(puzzle => puzzle.probNum === nextProbNum);
                                if (nextObj) {
                                    document.getElementById(`s${stageNum}-obj-${nextObj.obj}`).classList.remove('locked');
                                }

                                setTimeout(() => {
                                    hideModal(`s${stageNum}-modal-${p.modal}`);
                                }, 1500);

                            } else {
                                feedbackEl.textContent = 'ì•„ë‹ˆë‹¤. ë‹¨ì„œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ë³´ì.';
                                feedbackEl.style.color = 'red';
                            }
                        });
                    }
                });

                document.getElementById(`s${stageNum}-submit-final`).addEventListener('click', () => {
                    const finalInput = document.getElementById(`s${stageNum}-final-password`);
                    if (finalInput.value === finalPassword) {
                        if (stageNum < 3) {
                            document.getElementById('clear-title').textContent = `ìŠ¤í…Œì´ì§€ ${stageNum} í´ë¦¬ì–´!`;
                            document.getElementById('clear-message').textContent = nextStageMessage;
                            hideModal(`s${stageNum}-modal-final`);
                            showModal('stage-clear-modal');
                        } else {
                            clearInterval(timerInterval);
                            const finalTime = timerElement.textContent;
                            const finalModal = document.getElementById('s3-modal-final');
                            finalModal.querySelector('.modal-content').innerHTML = `
                                <h2>ìµœì¢… íƒˆì¶œ ì„±ê³µ!</h2>
                                <p style="font-size: 1.2rem; font-weight: bold;">ì´ ì†Œìš” ì‹œê°„: ${finalTime}</p>
                                <p>ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  êµì¹™ì„ ë§ˆìŠ¤í„°í•˜ê³  í•™êµì—ì„œ íƒˆì¶œí–ˆìŠµë‹ˆë‹¤!</p>`;
                            timerElement.style.display = 'none';
                        }
                    } else {
                        document.getElementById(`s${stageNum}-final-feedback`).textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
                    }
                });
            }

            // --- ìŠ¤í…Œì´ì§€ ë°ì´í„° ì •ì˜ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ ---
            // obj ìˆœì„œ: ì²« ë²ˆì§¸ ë¬¸ì œê°€ ë‘ ë²ˆì§¸ ë¬¸ì œë³´ë‹¤ ì•ì— ì™€ì•¼ í•¨
            setupStageEventListeners(1, [
                { obj: 'board', modal: 'hint' },
                { obj: 'skeleton', modal: 'problem1', isProblem: true, probNum: 1, answer: '03' },
                { obj: 'tools', modal: 'problem2', isProblem: true, probNum: 2, answer: '30' },
                { obj: 'box', modal: 'minigame', isGame: true, gameData: { icons: ['ğŸ”¬', 'ğŸ§ª', 'ğŸ§«', 'ğŸ§¬', 'âš›ï¸', 'ğŸ¥½'], frontIcon: '?', successMsg: 'ìƒìë¥¼ ì—´ì—ˆë‹¤! ë‚¡ì€ ê³¼í•™ ë„êµ¬ë§Œ ê°€ë“í•˜ë‹¤.' } },
                { obj: 'door', modal: 'final' }
            ], '0330', 'ì ê²¨ìˆë˜ ë¬¸ì´ ì—´ë¦¬ê³ , ì‹œë„ëŸ¬ìš´ ìŒì•… ì†Œë¦¬ê°€ ë“¤ë ¤ì˜¨ë‹¤...');

            setupStageEventListeners(2, [
                { obj: 'board', modal: 'hint' },
                { obj: 'statue', modal: 'problem1', isProblem: true, probNum: 1, answer: '01' },
                { obj: 'desk', modal: 'problem2', isProblem: true, probNum: 2, answer: '18' },
                { obj: 'piano', modal: 'minigame', isGame: true, gameData: { icons: ['ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥', 'ğŸ·', 'ğŸ¸'], frontIcon: 'â™ª', successMsg: 'í”¼ì•„ë…¸ ì† ì¹´ë“œë¥¼ ëª¨ë‘ ë§ì·„ë‹¤!' } },
                { obj: 'door', modal: 'final' }
            ], '0118', 'ë¬¸ì„ ì—´ì ë°”ê¹¥ì˜ ì‹œì›í•œ ë°”ëŒê³¼ ì•„ì´ë“¤ì˜ í•¨ì„± ì†Œë¦¬ê°€ ë“¤ë¦°ë‹¤!');

            setupStageEventListeners(3, [
                { obj: 'signboard', modal: 'hint' },
                { obj: 'soccer-ball', modal: 'problem1', isProblem: true, probNum: 1, answer: '01' },
                { obj: 'goalpost', modal: 'problem2', isProblem: true, probNum: 2, answer: '04' },
                { obj: 'swing', modal: 'minigame', isGame: true, gameData: { icons: ['âš½', 'ğŸ€', 'âš¾', 'ğŸ¾', 'ğŸ', 'ğŸ¸'], frontIcon: '?', successMsg: 'ëª¨ë“  ì¹´ë“œë¥¼ ë§ì·„ë‹¤! ê·¸ë„¤ë¥¼ ì‹ ë‚˜ê²Œ íƒ„ ê¸°ë¶„ì´ë‹¤.' } },
                { obj: 'exit-door', modal: 'final' }
            ], '0104');

            // --- ê³µìš© ë©”ëª¨ë¦¬ ì¹´ë“œ ê²Œì„ ë¡œì§ ---
            function startMemoryGame(stageNum, iconSet, frontIcon, successMessage) {
                const boardId = `s${stageNum}-memory-board`;
                const feedbackId = `s${stageNum}-minigame-feedback`;
                const memoryBoard = document.getElementById(boardId);
                const minigameFeedback = document.getElementById(feedbackId);
                
                let flippedCards = [];
                let lockBoard = false;
                let matchedPairs = 0;
                minigameFeedback.textContent = '';
                memoryBoard.innerHTML = '';
                let cardSet = [...iconSet, ...iconSet];
                cardSet.sort(() => 0.5 - Math.random());

                cardSet.forEach(icon => {
                    const cardElement = document.createElement('div');
                    cardElement.classList.add('card');
                    cardElement.dataset.icon = icon;
                    cardElement.innerHTML = `<div class="card-face card-front">${frontIcon}</div><div class="card-face card-back">${icon}</div>`;
                    cardElement.addEventListener('click', () => {
                        if (lockBoard || cardElement.classList.contains('flipped')) return;
                        cardElement.classList.add('flipped');
                        flippedCards.push(cardElement);
                        if (flippedCards.length === 2) {
                            lockBoard = true;
                            const [card1, card2] = flippedCards;
                            if (card1.dataset.icon === card2.dataset.icon) {
                                card1.classList.add('matched');
                                card2.classList.add('matched');
                                matchedPairs++;
                                flippedCards = [];
                                lockBoard = false;
                                if (matchedPairs === iconSet.length) {
                                    minigameFeedback.textContent = successMessage;
                                    minigameFeedback.style.color = 'purple';
                                    
                                    // ë¯¸ë‹ˆê²Œì„ í´ë¦¬ì–´ ì‹œ í•´ë‹¹ ì˜¤ë¸Œì íŠ¸ë„ solved ì²˜ë¦¬
                                    let gameObjId;
                                    if (stageNum === 1) gameObjId = 's1-obj-box';
                                    if (stageNum === 2) gameObjId = 's2-obj-piano';
                                    if (stageNum === 3) gameObjId = 's3-obj-swing';
                                    if(gameObjId) document.getElementById(gameObjId).classList.add('solved');
                                }
                            } else {
                                setTimeout(() => {
                                    card1.classList.remove('flipped');
                                    card2.classList.remove('flipped');
                                    flippedCards = [];
                                    lockBoard = false;
                                }, 1000);
                            }
                        }
                    });
                    memoryBoard.appendChild(cardElement);
                });
            }
        });
    </script>
</body>
</html>